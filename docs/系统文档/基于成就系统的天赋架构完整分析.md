# å¤©èµ‹ç³»ç»Ÿä¸æ–°VariableSystemæ•´åˆæ–¹æ¡ˆ

## ğŸ¯ æ•´åˆç›®æ ‡

åœ¨ä¸æ”¹åŠ¨ç°æœ‰å¤©èµ‹æ¶æ„çš„åŸºç¡€ä¸Šï¼Œè®©å¤©èµ‹æ•ˆæœä½¿ç”¨æ–°çš„VariableSystemï¼Œå®ç°ï¼š

- **ç²¾ç¡®çš„å¤©èµ‹æ•ˆæœè®¡ç®—**ï¼ˆåŸºç¡€å€¼+ç™¾åˆ†æ¯”ï¼‰
- **è‡ªåŠ¨çš„æ•ˆæœè¦†ç›–æ›´æ–°**ï¼ˆå‡çº§æ—¶æ— éœ€æ‰‹åŠ¨æ¸…ç†ï¼‰
- **ä¸ºè£…å¤‡ã€BUFFç³»ç»Ÿé¢„ç•™æ‰©å±•ç©ºé—´**

------

## ğŸ“‹ éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

### 1. Achievement.lua - ä¿®æ”¹å¤©èµ‹æ•ˆæœåº”ç”¨é€»è¾‘

#### åŸæœ‰ä»£ç 

```lua
function Achievement:_ApplyToVariableSystem(fieldName, effectValue, player)
    -- æ ¹æ®å˜é‡åå‰ç¼€å†³å®šåº”ç”¨æ–¹å¼
    if string.find(fieldName, "^åŠ æˆ_") or string.find(fieldName, "^è®¡æ•°_") then
        player.variableSystem:AddVariable(fieldName, effectValue)
    else
        player.variableSystem:SetVariable(fieldName, effectValue)
    end
end
```

#### ä¿®æ”¹åä»£ç 

```lua
function Achievement:_ApplyToVariableSystem(fieldName, effectValue, player)
    if not player.variableSystem then
        gg.log("ç©å®¶å˜é‡ç³»ç»Ÿä¸å­˜åœ¨:", self.playerId)
        return
    end
    
    -- ç”Ÿæˆå›ºå®šçš„å¤©èµ‹æ¥æºæ ‡è¯†ï¼ˆä¸å¸¦ç­‰çº§ï¼‰
    local source = "å¤©èµ‹_" .. self.achievementType.id
    
    -- æ ¹æ®å­—æ®µåå‰ç¼€åˆ¤æ–­æ•°å€¼ç±»å‹
    local valueType = string.find(fieldName, "^åŠ æˆ_") and "ç™¾åˆ†æ¯”" or "å›ºå®šå€¼"
    
    -- ä½¿ç”¨æ–°çš„å¤šæ¥æºæ¥å£ï¼ˆè‡ªåŠ¨è¦†ç›–åŒæ¥æºçš„æ—§å€¼ï¼‰
    player.variableSystem:SetSourceValue(fieldName, source, effectValue, valueType)
    
    gg.log(string.format("å¤©èµ‹[%s-L%d]åº”ç”¨å˜é‡æ•ˆæœ: %s = %s (%s, æ¥æº:%s)", 
        self.achievementType.id, self.currentLevel, 
        fieldName, tostring(effectValue), valueType, source))
end
```

### 2. AchievementMgr.lua - æ·»åŠ åŸºç¡€å€¼åˆå§‹åŒ–

#### åœ¨ `OnPlayerJoin` æ–¹æ³•å¼€å¤´æ·»åŠ 

```lua
function AchievementMgr.OnPlayerJoin(player)
    local playerId = tostring(player.uin)
    
    -- æ–°å¢ï¼šåˆå§‹åŒ–å˜é‡ç³»ç»ŸåŸºç¡€å€¼
    if player.variableSystem then
        -- ç™¾åˆ†æ¯”åŠ æˆç±»å˜é‡éœ€è¦è®¾ç½®åŸºç¡€å€¼
        player.variableSystem:SetBaseValue("åŠ æˆ_åŒå€è®­ç»ƒ", 100)
        player.variableSystem:SetBaseValue("åŠ æˆ_å¥–æ¯åŠ æˆ", 100)  
        player.variableSystem:SetBaseValue("åŠ æˆ_ç»éªŒè·å–", 100)
        player.variableSystem:SetBaseValue("åŠ æˆ_é‡‘å¸è·å–", 100)
        player.variableSystem:SetBaseValue("åŠ æˆ_è®­ç»ƒæ•ˆç‡", 100)
        
        -- è§£é”ç±»å˜é‡åŸºç¡€å€¼ä¸º0
        player.variableSystem:SetBaseValue("è§£é”_é‡ç”Ÿ", 0)
        player.variableSystem:SetBaseValue("è§£é”_åŒå€è®­ç»ƒ", 0)
        
        gg.log(string.format("ç©å®¶[%s]å˜é‡ç³»ç»ŸåŸºç¡€å€¼åˆå§‹åŒ–å®Œæˆ", playerId))
    end
    
    -- åŸæœ‰çš„æˆå°±åŠ è½½é€»è¾‘ä¿æŒä¸å˜
    AchievementMgr.server_player_achievement_data[playerId] = {}
    -- ...å…¶ä»–åŸæœ‰é€»è¾‘
end
```

------

## ğŸ® ä¸šåŠ¡ç³»ç»Ÿä¿®æ”¹

### è®­ç»ƒç³»ç»Ÿ - åº”ç”¨åŒå€è®­ç»ƒåŠ æˆ

```lua
-- åŸæœ‰è®­ç»ƒæ”¶ç›Šè®¡ç®—é€»è¾‘
function CalculateTrainingReward(player, baseReward)
    -- ä¿®æ”¹ï¼šä½¿ç”¨æ–°çš„å˜é‡ç³»ç»Ÿè·å–åŠ æˆ
    local hasDoubleTrain = player.variableSystem:CheckCondition("è§£é”_åŒå€è®­ç»ƒ", 1)
    
    if hasDoubleTrain then
        local trainBoost = player.variableSystem:GetVariable("åŠ æˆ_åŒå€è®­ç»ƒ") -- è·å–æœ€ç»ˆè®¡ç®—å€¼
        local finalReward = math.floor(baseReward * trainBoost / 100)
        
        gg.log(string.format("è®­ç»ƒæ”¶ç›Š: %d -> %d (åŒå€è®­ç»ƒåŠ æˆ: %d%%)", 
            baseReward, finalReward, trainBoost))
        return finalReward
    end
    
    return baseReward
end

-- ç»éªŒè·å–åŠ æˆ
function CalculateTrainingExp(player, baseExp)
    local expBoost = player.variableSystem:GetVariable("åŠ æˆ_ç»éªŒè·å–")
    local finalExp = math.floor(baseExp * expBoost / 100)
    
    gg.log(string.format("è®­ç»ƒç»éªŒ: %d -> %d (ç»éªŒåŠ æˆ: %d%%)", 
        baseExp, finalExp, expBoost))
    return finalExp
end
```

### å¥–æ¯ç³»ç»Ÿ - åº”ç”¨å¥–æ¯è·å–åŠ æˆ

```lua
function AwardTrophies(player, baseTrophies, reason)
    local trophyBoost = player.variableSystem:GetVariable("åŠ æˆ_å¥–æ¯åŠ æˆ")
    local finalTrophies = math.floor(baseTrophies * trophyBoost / 100)
    
    -- æ·»åŠ åˆ°ç©å®¶èƒŒåŒ…
    player.bag:AddItem("å¥–æ¯", finalTrophies)
    
    gg.log(string.format("ç©å®¶[%s]è·å¾—å¥–æ¯: %dä¸ª (åŸºç¡€:%d, åŠ æˆ:%d%%, åŸå› :%s)", 
        player.uin, finalTrophies, baseTrophies, trophyBoost, reason))
    
    return finalTrophies
end
```

### é‡ç”Ÿç³»ç»Ÿ - æ£€æŸ¥é‡ç”Ÿæ ä½

```lua
function GetAvailableRebirthSlots(player)
    local rebirthSlots = player.variableSystem:GetVariable("è§£é”_é‡ç”Ÿ", 1)
    return math.max(1, math.floor(rebirthSlots)) -- è‡³å°‘ä¿è¯1ä¸ªæ ä½
end

function CanRebirth(player)
    local availableSlots = GetAvailableRebirthSlots(player)
    local usedSlots = GetUsedRebirthSlots(player) -- ä¸šåŠ¡å±‚å®ç°
    
    return usedSlots < availableSlots
end
```

------

## ğŸ“Š æ•°æ®æµè½¬ç¤ºä¾‹

### ç¤ºä¾‹ï¼šåŒå€è®­ç»ƒå¤©èµ‹å‡çº§è¿‡ç¨‹

#### é…ç½®æ•°æ®

```lua
-- AchievementConfig.lua
['åŒå€è®­ç»ƒ'] = {
    ['æœ€å¤§ç­‰çº§'] = 20,
    ['ç­‰çº§æ•ˆæœ'] = {
        {
            ['æ•ˆæœç±»å‹'] = 'ç©å®¶å˜é‡',
            ['æ•ˆæœå­—æ®µåç§°'] = 'åŠ æˆ_åŒå€è®­ç»ƒ',
            ['æ•ˆæœæ•°å€¼'] = 'T_LVL*0.2',  -- æ¯çº§+20%
        },
    },
}
```

#### L1 â†’ L5å‡çº§è¿‡ç¨‹

```lua
-- ç³»ç»Ÿåˆå§‹åŒ–
åŸºç¡€å€¼: SetBaseValue("åŠ æˆ_åŒå€è®­ç»ƒ", 100)

-- L1è§£é” (T_LVL*0.2 = 1*0.2*100 = 20)
SetSourceValue("åŠ æˆ_åŒå€è®­ç»ƒ", "å¤©èµ‹_åŒå€è®­ç»ƒ", 20, "ç™¾åˆ†æ¯”")
æœ€ç»ˆå€¼ = 100 + 0 + 100*20/100 = 120%

-- L2å‡çº§ (T_LVL*0.2 = 2*0.2*100 = 40)  
SetSourceValue("åŠ æˆ_åŒå€è®­ç»ƒ", "å¤©èµ‹_åŒå€è®­ç»ƒ", 40, "ç™¾åˆ†æ¯”") -- è‡ªåŠ¨è¦†ç›–20
æœ€ç»ˆå€¼ = 100 + 0 + 100*40/100 = 140%

-- L5å‡çº§ (T_LVL*0.2 = 5*0.2*100 = 100)
SetSourceValue("åŠ æˆ_åŒå€è®­ç»ƒ", "å¤©èµ‹_åŒå€è®­ç»ƒ", 100, "ç™¾åˆ†æ¯”") -- è‡ªåŠ¨è¦†ç›–40
æœ€ç»ˆå€¼ = 100 + 0 + 100*100/100 = 200%
```

#### å˜é‡ç³»ç»Ÿå†…éƒ¨æ•°æ®ç»“æ„

```lua
player.variableSystem.variables = {
    ["åŠ æˆ_åŒå€è®­ç»ƒ"] = {
        base = 100,
        sources = {
            ["å¤©èµ‹_åŒå€è®­ç»ƒ"] = {value = 100, type = "ç™¾åˆ†æ¯”"}
        }
        -- GetVariable() è¿”å›: 100 + 0 + 100*100/100 = 200
    },
    ["è§£é”_é‡ç”Ÿ"] = {
        base = 0,
        sources = {
            ["å¤©èµ‹_é‡ç”Ÿ"] = {value = 21, type = "å›ºå®šå€¼"}  -- T_LVL*2+1 = 10*2+1 = 21
        }
        -- GetVariable() è¿”å›: 0 + 21 + 0*0/100 = 21
    }
}
```

#### ä¸šåŠ¡ç³»ç»Ÿä½¿ç”¨

```lua
-- ç©å®¶è¿›è¡Œè®­ç»ƒï¼ŒåŸºç¡€æ”¶ç›Š100ç»éªŒ
local baseReward = 100
local trainBoost = player.variableSystem:GetVariable("åŠ æˆ_åŒå€è®­ç»ƒ") -- 200
local finalReward = math.floor(baseReward * trainBoost / 100)          -- 100 * 200/100 = 200

gg.log("è®­ç»ƒæ”¶ç›Š: 100 -> 200 (åŒå€è®­ç»ƒL5: 200%)")
```

------

## âš¡ å®æ–½æ­¥éª¤

### ç¬¬1æ­¥ï¼šä¿®æ”¹æ ¸å¿ƒé€»è¾‘ï¼ˆ30åˆ†é’Ÿï¼‰

1. ä¿®æ”¹ `Achievement.lua` çš„ `_ApplyToVariableSystem` æ–¹æ³•
2. ä¿®æ”¹ `AchievementMgr.lua` çš„ `OnPlayerJoin` æ–¹æ³•

### ç¬¬2æ­¥ï¼šä¿®æ”¹ä¸šåŠ¡ç³»ç»Ÿï¼ˆ30åˆ†é’Ÿï¼‰

1. ä¿®æ”¹è®­ç»ƒç³»ç»Ÿçš„æ”¶ç›Šè®¡ç®—
2. ä¿®æ”¹å¥–æ¯ç³»ç»Ÿçš„è·å–è®¡ç®—
3. ä¿®æ”¹é‡ç”Ÿç³»ç»Ÿçš„æ ä½æ£€æŸ¥

### ç¬¬3æ­¥ï¼šæµ‹è¯•éªŒè¯ï¼ˆ30åˆ†é’Ÿï¼‰

1. æµ‹è¯•å¤©èµ‹å‡çº§æ•ˆæœæ­£ç¡®æ€§
2. æµ‹è¯•ä¸šåŠ¡ç³»ç»ŸåŠ æˆç”Ÿæ•ˆ
3. éªŒè¯æ•°æ®è®¡ç®—å‡†ç¡®æ€§

------

## ğŸ‰ æ ¸å¿ƒä¼˜åŠ¿

### æŠ€æœ¯ä¼˜åŠ¿

- **è‡ªåŠ¨è¦†ç›–**ï¼šå¤©èµ‹å‡çº§æ—¶åŒä¸€æ¥æºçš„æ–°æ•ˆæœè‡ªåŠ¨è¦†ç›–æ—§æ•ˆæœ
- **ç²¾ç¡®è®¡ç®—**ï¼šåŸºç¡€å€¼+ç™¾åˆ†æ¯”çš„æ··åˆè®¡ç®—æ›´å‡†ç¡®
- **æ‰©å±•æ€§**ï¼šä¸ºè£…å¤‡ã€BUFFç­‰å…¶ä»–æ¥æºé¢„ç•™äº†æ¥å£

### ä¸šåŠ¡ä¼˜åŠ¿

- **é…ç½®ä¸å˜**ï¼šç°æœ‰çš„AchievementConfig.luaå®Œå…¨ä¸ç”¨æ”¹
- **UIä¸å˜**ï¼šå®¢æˆ·ç«¯ç•Œé¢å’Œç½‘ç»œé€šä¿¡å®Œå…¨ä¸ç”¨æ”¹
- **å‘åå…¼å®¹**ï¼šç°æœ‰ç©å®¶æ•°æ®è‡ªåŠ¨é€‚é…æ–°ç³»ç»Ÿ

### å¼€å‘ä¼˜åŠ¿

- **æ”¹åŠ¨æœ€å°**ï¼šåªéœ€ä¿®æ”¹2ä¸ªæ–¹æ³•å’Œå‡ ä¸ªä¸šåŠ¡è°ƒç”¨
- **é£é™©æœ€ä½**ï¼šæ ¸å¿ƒæ¶æ„å®Œå…¨ä¸å˜
- **è°ƒè¯•ç®€å•**ï¼šå¯ä»¥é€šè¿‡ `GetVariableSources()` æŸ¥çœ‹æ•ˆæœæ¥æº

------

## ğŸ” è°ƒè¯•å’ŒéªŒè¯

### æŸ¥çœ‹å¤©èµ‹æ•ˆæœè¯¦æƒ…

```lua
-- è°ƒè¯•å‡½æ•°ï¼šæŸ¥çœ‹ç©å®¶å¤©èµ‹æ•ˆæœ
function DebugPlayerTalentEffects(player)
    local details = player.variableSystem:GetVariableSources("åŠ æˆ_åŒå€è®­ç»ƒ")
    if details then
        print(string.format("åŒå€è®­ç»ƒæ•ˆæœè¯¦æƒ…:"))
        print(string.format("  åŸºç¡€å€¼: %d%%", details.base))
        print(string.format("  æœ€ç»ˆå€¼: %d%%", details.finalValue))
        print(string.format("  æ•ˆæœæ¥æº:"))
        for source, data in pairs(details.sources) do
            print(string.format("    %s: +%d%% (%s)", source, data.value, data.type))
        end
    end
end
```

### éªŒè¯å‡çº§æ­£ç¡®æ€§

```lua
-- æµ‹è¯•å¤©èµ‹å‡çº§
function TestTalentUpgrade(player, talentId)
    local beforeValue = player.variableSystem:GetVariable("åŠ æˆ_" .. talentId)
    
    -- æ‰§è¡Œå‡çº§
    AchievementMgr.UpgradeAchievement(player, talentId)
    
    local afterValue = player.variableSystem:GetVariable("åŠ æˆ_" .. talentId)
    
    print(string.format("å¤©èµ‹[%s]å‡çº§: %d%% -> %d%%", talentId, beforeValue, afterValue))
end
```

------

## æ€»ç»“

è¿™ä¸ªæ•´åˆæ–¹æ¡ˆç”¨**æœ€å°çš„æ”¹åŠ¨**å®ç°äº†**æœ€å¤§çš„æ•ˆæœæå‡**ï¼š

- âœ… **åªæ”¹2ä¸ªæ–¹æ³•**ï¼šæ•ˆæœåº”ç”¨é€»è¾‘ + åŸºç¡€å€¼åˆå§‹åŒ–
- âœ… **è‡ªåŠ¨æ•ˆæœè¦†ç›–**ï¼šå‡çº§æ—¶æ— éœ€æ‰‹åŠ¨æ¸…ç†ï¼Œç³»ç»Ÿè‡ªåŠ¨å¤„ç†
- âœ… **ç²¾ç¡®æ•°å€¼è®¡ç®—**ï¼šåŸºç¡€å€¼+ç™¾åˆ†æ¯”çš„å‡†ç¡®è®¡ç®—
- âœ… **å®Œå…¨å‘åå…¼å®¹**ï¼šé…ç½®ã€UIã€ç½‘ç»œåè®®éƒ½ä¸ç”¨æ”¹
- âœ… **æ‰©å±•æ€§é¢„ç•™**ï¼šä¸ºè£…å¤‡ã€BUFFç³»ç»Ÿç•™å¥½æ¥å£

ç¬¦åˆé¡¹ç›®çš„KISSåŸåˆ™ï¼šç®€å•ã€ç›´æ¥ã€æœ‰æ•ˆï¼