# æ¨¡å—åŒ–ç»„ä»¶ç³»ç»Ÿæœ€ç»ˆè®¾è®¡æ–¹æ¡ˆ

## ä¸€ã€æ ¸å¿ƒæ¶æ„æ¦‚è§ˆ

### 1.1 è®¾è®¡ç†å¿µ

```
æ¨¡å—åŒ–ç®¡ç†ï¼šæ¯ä¸ªåŠŸèƒ½ç‹¬ç«‹ç®¡ç†ï¼Œå‚ç…§BagMgræ¨¡å¼
æ•°æ®é€»è¾‘åˆ†ç¦»ï¼šæ•°æ®ç»“æ„ç»„ä»¶åŒ–ï¼Œé€»è¾‘åœ¨å„è‡ªç®¡ç†å™¨ä¸­
è½»é‡çº§å®ä½“ï¼šEntityåªä½œä¸ºè½»é‡çº§å®¹å™¨ï¼Œä¸åŒ…å«å…·ä½“ä¸šåŠ¡é€»è¾‘
æ¸è¿›å¼é‡æ„ï¼šä¿æŒç°æœ‰åŠŸèƒ½å…¼å®¹ï¼Œåˆ†é˜¶æ®µå¹³ç¨³è¿ç§»
```

### 1.2 æ¶æ„åˆ†å±‚

```
ğŸ® æ¸¸æˆå±‚: ç°æœ‰æ¸¸æˆé€»è¾‘å’ŒUIäº¤äº’
    â†“
ğŸ­ ç®¡ç†å±‚: BagMgrã€SkillMgrã€MailMgrç­‰ç‹¬ç«‹ç®¡ç†å™¨
    â†“
ğŸ—ƒï¸ æ•°æ®å±‚: å„ç®¡ç†å™¨ç‹¬ç«‹å­˜å‚¨ç»„ä»¶åŒ–æ•°æ®
    â†“
ğŸ†” å®ä½“å±‚: Entityå®ä¾‹ï¼Œä½œä¸ºè½»é‡çº§å®¹å™¨
    â†“
ğŸ“¦ åŸºç¡€å±‚: åªéœ€è¦EntityåŸºç±»ï¼Œç§»é™¤Componentå’ŒSystemåŸºç±»
```

## äºŒã€æ ¸å¿ƒæ¶æ„è®¾è®¡

### 2.1 ğŸ“¦ [åŸºç¡€ç±»] è½»é‡çº§Entity

#### Entity (å®ä½“åŸºç±»)

```
èŒè´£ï¼šè½»é‡çº§å®¹å™¨ï¼Œåªä¿ç•™åŸºæœ¬æ ‡è¯†
æ ¸å¿ƒå±æ€§ï¼š
â”œâ”€â”€ entityId: å”¯ä¸€æ ‡è¯†ç¬¦ (é€šå¸¸ä½¿ç”¨uin)
â”œâ”€â”€ name: å®ä½“åç§°
â””â”€â”€ isPlayer: æ˜¯å¦ä¸ºç©å®¶

ç®€åŒ–æ–¹æ³•ï¼š
â”œâ”€â”€ GetBag(): é‡å®šå‘åˆ°BagMgr.GetPlayerBag(uin)
â”œâ”€â”€ GetSkillData(): é‡å®šå‘åˆ°SkillMgr.GetPlayerSkill(uin)
â”œâ”€â”€ GetMailData(): é‡å®šå‘åˆ°MailMgr.GetPlayerMail(uin)
â””â”€â”€ å…¶ä»–ä¾¿æ°‘æ–¹æ³•

ä½¿ç”¨åœºæ™¯ï¼š
â”œâ”€â”€ MPlayer: ç©å®¶å®ä½“ï¼Œé€šè¿‡å„ç®¡ç†å™¨è®¿é—®æ•°æ®
â”œâ”€â”€ MNpc: NPCå®ä½“ï¼Œé€šè¿‡å¯¹è¯ç®¡ç†å™¨è®¿é—®æ•°æ®
â””â”€â”€ MMonster: æ€ªç‰©å®ä½“ï¼Œé€šè¿‡AIç®¡ç†å™¨è®¿é—®æ•°æ®
```

### 2.2 ğŸ­ [ç‹¬ç«‹ç®¡ç†å™¨] å„åŠŸèƒ½æ¨¡å—ç®¡ç†å™¨

#### BagMgr (èƒŒåŒ…ç®¡ç†å™¨) - å‚è€ƒæ¨¡æ¿

```
èŒè´£ï¼šç‹¬ç«‹ç®¡ç†èƒŒåŒ…ç›¸å…³çš„æ‰€æœ‰åŠŸèƒ½
æ•°æ®å­˜å‚¨ï¼š
server_player_bag_data = {
    [uin] = {
        bagItems = {},      -- èƒŒåŒ…ç‰©å“
        bagIndex = {},      -- ç‰©å“ç´¢å¼•  
        maxSlots = 100,     -- æœ€å¤§æ§½ä½
        loaded = false      -- æ˜¯å¦å·²åŠ è½½
    }
}

æ ¸å¿ƒæ–¹æ³•ï¼š
â”œâ”€â”€ GetPlayerBag(uin): è·å–ç©å®¶èƒŒåŒ…æ•°æ®
â”œâ”€â”€ setPlayerBagData(uin, data): è®¾ç½®èƒŒåŒ…æ•°æ®
â”œâ”€â”€ handleBtnUseItem(uin, param): å¤„ç†ä½¿ç”¨ç‰©å“
â”œâ”€â”€ LoadPlayerBagFromCloud(player): ä»äº‘ç«¯åŠ è½½
â”œâ”€â”€ SavePlayerBagToCloud(player): ä¿å­˜åˆ°äº‘ç«¯
â””â”€â”€ syncBagToClient(uin): åŒæ­¥åˆ°å®¢æˆ·ç«¯

åŒæ­¥æœºåˆ¶ï¼š
â”œâ”€â”€ need_sync_bag: æ ‡è®°éœ€è¦åŒæ­¥çš„èƒŒåŒ…
â”œâ”€â”€ å®šæ—¶å™¨è‡ªåŠ¨åŒæ­¥è„æ•°æ®
â””â”€â”€ äº‹ä»¶é©±åŠ¨çš„å³æ—¶åŒæ­¥
```

#### SkillMgr (æŠ€èƒ½ç®¡ç†å™¨) - æ–°å¢

```
èŒè´£ï¼šç‹¬ç«‹ç®¡ç†æŠ€èƒ½ç›¸å…³çš„æ‰€æœ‰åŠŸèƒ½
æ•°æ®å­˜å‚¨ï¼š
server_player_skill_data = {
    [uin] = {
        learnedSkills = {},    -- å·²å­¦æŠ€èƒ½
        equippedSkills = {},   -- è£…å¤‡æŠ€èƒ½
        skillPoints = 10,      -- æŠ€èƒ½ç‚¹
        maxSkillSlots = 5      -- æœ€å¤§æ§½ä½
    }
}

æ ¸å¿ƒæ–¹æ³•ï¼š
â”œâ”€â”€ GetPlayerSkill(uin): è·å–ç©å®¶æŠ€èƒ½æ•°æ®
â”œâ”€â”€ setPlayerSkillData(uin, data): è®¾ç½®æŠ€èƒ½æ•°æ®
â”œâ”€â”€ handleLearnSkill(uin, param): å¤„ç†å­¦ä¹ æŠ€èƒ½
â”œâ”€â”€ handleEquipSkill(uin, param): å¤„ç†è£…å¤‡æŠ€èƒ½
â”œâ”€â”€ LoadPlayerSkillFromCloud(player): ä»äº‘ç«¯åŠ è½½
â”œâ”€â”€ SavePlayerSkillToCloud(player): ä¿å­˜åˆ°äº‘ç«¯
â””â”€â”€ syncSkillToClient(uin): åŒæ­¥åˆ°å®¢æˆ·ç«¯

åŒæ­¥æœºåˆ¶ï¼š
â”œâ”€â”€ need_sync_skill: æ ‡è®°éœ€è¦åŒæ­¥çš„æŠ€èƒ½
â”œâ”€â”€ å®šæ—¶å™¨è‡ªåŠ¨åŒæ­¥è„æ•°æ®
â””â”€â”€ äº‹ä»¶é©±åŠ¨çš„å³æ—¶åŒæ­¥
```

#### MailMgr (é‚®ä»¶ç®¡ç†å™¨) - æ–°å¢

```
èŒè´£ï¼šç‹¬ç«‹ç®¡ç†é‚®ä»¶ç›¸å…³çš„æ‰€æœ‰åŠŸèƒ½
æ•°æ®å­˜å‚¨ï¼š
server_player_mail_data = {
    [uin] = {
        inbox = {},         -- æ”¶ä»¶ç®±
        unreadCount = 0,    -- æœªè¯»æ•°é‡
        maxInboxSize = 50   -- æœ€å¤§æ”¶ä»¶æ•°
    }
}

æ ¸å¿ƒæ–¹æ³•ï¼š
â”œâ”€â”€ GetPlayerMail(uin): è·å–ç©å®¶é‚®ä»¶æ•°æ®
â”œâ”€â”€ setPlayerMailData(uin, data): è®¾ç½®é‚®ä»¶æ•°æ®
â”œâ”€â”€ handleSendMail(uin, param): å¤„ç†å‘é€é‚®ä»¶
â”œâ”€â”€ handleReadMail(uin, param): å¤„ç†è¯»å–é‚®ä»¶
â”œâ”€â”€ LoadPlayerMailFromCloud(player): ä»äº‘ç«¯åŠ è½½
â”œâ”€â”€ SavePlayerMailToCloud(player): ä¿å­˜åˆ°äº‘ç«¯
â””â”€â”€ syncMailToClient(uin): åŒæ­¥åˆ°å®¢æˆ·ç«¯

åŒæ­¥æœºåˆ¶ï¼š
â”œâ”€â”€ need_sync_mail: æ ‡è®°éœ€è¦åŒæ­¥çš„é‚®ä»¶
â”œâ”€â”€ å®šæ—¶å™¨è‡ªåŠ¨åŒæ­¥è„æ•°æ®
â””â”€â”€ äº‹ä»¶é©±åŠ¨çš„å³æ—¶åŒæ­¥
```

## ä¸‰ã€å„ç®¡ç†å™¨æ•°æ®ç»“æ„è®¾è®¡

### 3.1 ğŸ—ƒï¸ [æ•°æ®ç»“æ„] æŠ€èƒ½ç®¡ç†å™¨æ•°æ®

#### SkillMgræ•°æ®ç»“æ„

```
server_player_skill_data = {
    [uin] = {
        -- å·²å­¦ä¹ çš„æŠ€èƒ½
        learnedSkills = {
            ["fire_ball"] = { 
                level = 5, 
                exp = 1200,
                learnTime = 1234567890 
            },
            ["heal"] = { 
                level = 3, 
                exp = 800,
                learnTime = 1234567890 
            }
        },
        
        -- è£…å¤‡çš„æŠ€èƒ½ (æ§½ä½ -> æŠ€èƒ½ID)
        equippedSkills = {
            [1] = "fire_ball",  -- ä¸»æ§½ä½
            [2] = "heal",       -- å‰¯æ§½ä½1
            [3] = nil,          -- å‰¯æ§½ä½2 (æœªè£…å¤‡)
            [4] = nil,          -- å‰¯æ§½ä½3 (æœªè£…å¤‡)
            [5] = nil           -- å‰¯æ§½ä½4 (æœªè£…å¤‡)
        },
        
        -- æŠ€èƒ½å†·å´çŠ¶æ€
        activeCooldowns = {
            ["fire_ball"] = 2.5,  -- å‰©ä½™2.5ç§’
            ["heal"] = 0.8        -- å‰©ä½™0.8ç§’
        },
        
        -- åŸºç¡€å±æ€§
        skillPoints = 10,           -- å¯ç”¨æŠ€èƒ½ç‚¹
        maxSkillSlots = 5,          -- æœ€å¤§æŠ€èƒ½æ§½æ•°
        lastLearnTime = 1234567890, -- æœ€åå­¦ä¹ æ—¶é—´
        globalCooldownEnd = 0,      -- å…¨å±€å†·å´ç»“æŸæ—¶é—´
        
        -- æ§½ä½è§£é”çŠ¶æ€
        slotLocks = {
            [1] = false,  -- ä¸»æ§½ä½é»˜è®¤è§£é”
            [2] = false,  -- å‰¯æ§½ä½1è§£é”
            [3] = true,   -- å‰¯æ§½ä½2é”å®š
            [4] = true,   -- å‰¯æ§½ä½3é”å®š
            [5] = true    -- å‰¯æ§½ä½4é”å®š
        }
    }
}
```

### 3.2 ğŸ—ƒï¸ [æ•°æ®ç»“æ„] èƒŒåŒ…ç®¡ç†å™¨æ•°æ®

#### BagMgræ•°æ®ç»“æ„ (ç°æœ‰ç»“æ„ç»„ä»¶åŒ–)

```
server_player_bag_data = {
    [uin] = {
        -- èƒŒåŒ…ç‰©å“ (åˆ†ç±»å­˜å‚¨)
        bagItems = {
            [1] = {  -- è£…å¤‡ç±»
                [1] = { name = "é“å‰‘", amount = 1, enhanceLevel = 5 },
                [2] = { name = "çš®ç”²", amount = 1, enhanceLevel = 2 }
            },
            [2] = {  -- æ¶ˆè€—å“ç±»
                [1] = { name = "ç”Ÿå‘½è¯æ°´", amount = 99 },
                [2] = { name = "æ³•åŠ›è¯æ°´", amount = 50 }
            },
            [5] = {  -- è´§å¸ç±»
                [1] = { name = "é‡‘å¸", amount = 10000 },
                [2] = { name = "é’»çŸ³", amount = 500 }
            }
        },
        
        -- ç‰©å“åç§°ç´¢å¼• (å¿«é€ŸæŸ¥æ‰¾)
        bagIndex = {
            ["é“å‰‘"] = { {c = 1, s = 1} },
            ["ç”Ÿå‘½è¯æ°´"] = { {c = 2, s = 1} },
            ["é‡‘å¸"] = { {c = 5, s = 1} }
        },
        
        -- èƒŒåŒ…å±æ€§
        maxSlots = 100,          -- æœ€å¤§æ§½ä½æ•°
        loaded = false,          -- æ˜¯å¦å·²ä»äº‘ç«¯åŠ è½½
        dirtySyncSlots = {},     -- éœ€è¦åŒæ­¥çš„æ§½ä½
        dirtySave = false        -- æ˜¯å¦éœ€è¦ä¿å­˜
    }
}
```

### 3.3 ğŸ—ƒï¸ [æ•°æ®ç»“æ„] é‚®ä»¶ç®¡ç†å™¨æ•°æ®

#### MailMgræ•°æ®ç»“æ„

```
server_player_mail_data = {
    [uin] = {
        -- æ”¶ä»¶ç®±
        inbox = {
            [1] = {
                id = "mail_001",
                fromUin = 12345,
                fromName = "ç³»ç»Ÿ",
                title = "æ¬¢è¿å¥–åŠ±",
                content = "æ¬¢è¿æ¥åˆ°æ¸¸æˆä¸–ç•Œï¼",
                attachments = {
                    { itemName = "é‡‘å¸", amount = 1000 },
                    { itemName = "ç”Ÿå‘½è¯æ°´", amount = 5 }
                },
                sendTime = 1234567890,
                isRead = false,
                isReceived = false  -- é™„ä»¶æ˜¯å¦å·²é¢†å–
            }
        },
        
        -- å‘ä»¶ç®± (å¯é€‰)
        outbox = {
            [1] = {
                id = "mail_001",
                toUin = 67890,
                title = "å¥½å‹é‚€è¯·",
                sendTime = 1234567890
            }
        },
        
        -- é‚®ä»¶å±æ€§
        unreadCount = 1,         -- æœªè¯»é‚®ä»¶æ•°é‡
        maxInboxSize = 50,       -- æ”¶ä»¶ç®±æœ€å¤§å®¹é‡
        lastCheckTime = 0        -- æœ€åæ£€æŸ¥æ—¶é—´
    }
}
```

### 3.4 ğŸ—ƒï¸ [æ•°æ®ç»“æ„] å…¶ä»–ç®¡ç†å™¨æ‰©å±•

#### ä»»åŠ¡ç®¡ç†å™¨æ•°æ®ç»“æ„ (TaskMgr)

```
server_player_task_data = {
    [uin] = {
        -- å½“å‰ä»»åŠ¡
        activeTasks = {
            ["task_001"] = {
                taskId = "task_001",
                progress = { kill_monster = 5, collect_item = 3 },
                startTime = 1234567890,
                status = "active"  -- active/completed/failed
            }
        },
        
        -- å·²å®Œæˆä»»åŠ¡
        completedTasks = {
            ["task_000"] = {
                taskId = "task_000",
                completeTime = 1234567890,
                rewards = { exp = 100, gold = 50 }
            }
        },
        
        -- ä»»åŠ¡å±æ€§
        maxActiveTasks = 10,     -- æœ€å¤§åŒæ—¶ä»»åŠ¡æ•°
        totalCompleted = 1       -- æ€»å®Œæˆä»»åŠ¡æ•°
    }
}
```

#### å¥½å‹ç®¡ç†å™¨æ•°æ®ç»“æ„ (FriendMgr)

```
server_player_friend_data = {
    [uin] = {
        -- å¥½å‹åˆ—è¡¨
        friends = {
            [12345] = {
                uin = 12345,
                nickname = "å¥½å‹1",
                addTime = 1234567890,
                lastOnlineTime = 1234567890,
                intimacy = 100  -- äº²å¯†åº¦
            }
        },
        
        -- å¥½å‹è¯·æ±‚
        friendRequests = {
            [67890] = {
                fromUin = 67890,
                fromName = "ç©å®¶A",
                requestTime = 1234567890,
                message = "åŠ ä¸ªå¥½å‹å§"
            }
        },
        
        -- å¥½å‹å±æ€§
        maxFriends = 100,        -- æœ€å¤§å¥½å‹æ•°
        friendRequestCount = 1   -- å¾…å¤„ç†å¥½å‹è¯·æ±‚æ•°
    }
}
```

### 3.5 ğŸ—ƒï¸ [é…ç½®æ•°æ®] é™æ€é…ç½® (ä¿æŒä¸å˜)

```
æŠ€èƒ½é…ç½®æ•°æ® (ç”±ç°æœ‰Configç³»ç»Ÿç®¡ç†):
skillConfigs = {
    ["fire_ball"] = {
        skillName = "ç«çƒæœ¯",
        damage = 100,
        manaCost = 50,
        castTime = 2.0,
        cooldown = 8.0,
        effects = { ... },
        targeting = { ... }
    }
}

é“å…·é…ç½®æ•°æ® (ç”±ç°æœ‰Configç³»ç»Ÿç®¡ç†):
itemConfigs = {
    ["health_potion"] = {
        itemName = "ç”Ÿå‘½è¯æ°´",
        itemType = "consumable",
        healAmount = 50,
        description = "æ¢å¤50ç‚¹ç”Ÿå‘½å€¼"
    }
}

ç‰¹æ•ˆå¤„ç† (ç”±ç°æœ‰ç‰¹æ•ˆç³»ç»Ÿç®¡ç†):
- æŠ•å°„ç‰©ä½œä¸ºæŠ€èƒ½æ•ˆæœçš„ä¸€éƒ¨åˆ†å¤„ç†
- ç‰¹æ•ˆä½œä¸ºä¸´æ—¶è§†è§‰è¡¨ç°å¤„ç†
- å»ºç­‘ç‰©ä½œä¸ºåœºæ™¯å¯¹è±¡å¤„ç†
```

## å››ã€å„ç®¡ç†å™¨å®ç°è®¾è®¡

### 4.1 ğŸ”§ [ç®¡ç†å™¨] æŠ€èƒ½ç®¡ç†å™¨å®ç°

#### SkillMgr (æŠ€èƒ½ç®¡ç†å™¨)

```
å‚ç…§ï¼šBagMgrçš„å®ç°æ¨¡å¼
èŒè´£ï¼šç‹¬ç«‹å¤„ç†æŠ€èƒ½ç›¸å…³çš„æ‰€æœ‰åŠŸèƒ½

æ•°æ®å­˜å‚¨ï¼š
server_player_skill_data = {}  -- ç©å®¶æŠ€èƒ½æ•°æ®
need_sync_skill = {}          -- éœ€è¦åŒæ­¥çš„æŠ€èƒ½

æ ¸å¿ƒæ–¹æ³•ï¼š
â”œâ”€â”€ GetPlayerSkill(uin): è·å–ç©å®¶æŠ€èƒ½æ•°æ®
â”œâ”€â”€ setPlayerSkillData(uin, data): è®¾ç½®æŠ€èƒ½æ•°æ®
â”œâ”€â”€ handleLearnSkill(uin, param): å¤„ç†å­¦ä¹ æŠ€èƒ½è¯·æ±‚
â”œâ”€â”€ handleEquipSkill(uin, param): å¤„ç†è£…å¤‡æŠ€èƒ½è¯·æ±‚
â”œâ”€â”€ handleUnequipSkill(uin, param): å¤„ç†å¸ä¸‹æŠ€èƒ½è¯·æ±‚
â”œâ”€â”€ handleUpgradeSkill(uin, param): å¤„ç†å‡çº§æŠ€èƒ½è¯·æ±‚
â”œâ”€â”€ LoadPlayerSkillFromCloud(player): ä»äº‘ç«¯åŠ è½½æŠ€èƒ½æ•°æ®
â”œâ”€â”€ SavePlayerSkillToCloud(player): ä¿å­˜æŠ€èƒ½æ•°æ®åˆ°äº‘ç«¯
â””â”€â”€ syncSkillToClient(uin): åŒæ­¥æŠ€èƒ½æ•°æ®åˆ°å®¢æˆ·ç«¯

å®šæ—¶åŒæ­¥æœºåˆ¶ï¼š
â”œâ”€â”€ åˆ›å»ºTimerå®šæ—¶å™¨ (å‚ç…§BagMgr)
â”œâ”€â”€ SyncAllSkills(): æ‰¹é‡åŒæ­¥æ‰€æœ‰è„æ•°æ®
â”œâ”€â”€ 2ç§’é—´éš”è‡ªåŠ¨åŒæ­¥
â””â”€â”€ äº‹ä»¶é©±åŠ¨çš„å³æ—¶åŒæ­¥

äº‹ä»¶å¤„ç†ï¼š
â”œâ”€â”€ æ³¨å†ŒæŠ€èƒ½ç›¸å…³çš„ç½‘ç»œäº‹ä»¶
â”œâ”€â”€ å¤„ç†å®¢æˆ·ç«¯æŠ€èƒ½æ“ä½œè¯·æ±‚
â”œâ”€â”€ éªŒè¯æŠ€èƒ½æ“ä½œçš„åˆæ³•æ€§
â””â”€â”€ è¿”å›æ“ä½œç»“æœç»™å®¢æˆ·ç«¯
```

#### MailMgr (é‚®ä»¶ç®¡ç†å™¨)

```
å‚ç…§ï¼šBagMgrçš„å®ç°æ¨¡å¼
èŒè´£ï¼šç‹¬ç«‹å¤„ç†é‚®ä»¶ç›¸å…³çš„æ‰€æœ‰åŠŸèƒ½

æ•°æ®å­˜å‚¨ï¼š
server_player_mail_data = {}  -- ç©å®¶é‚®ä»¶æ•°æ®
need_sync_mail = {}          -- éœ€è¦åŒæ­¥çš„é‚®ä»¶

æ ¸å¿ƒæ–¹æ³•ï¼š
â”œâ”€â”€ GetPlayerMail(uin): è·å–ç©å®¶é‚®ä»¶æ•°æ®
â”œâ”€â”€ setPlayerMailData(uin, data): è®¾ç½®é‚®ä»¶æ•°æ®
â”œâ”€â”€ handleSendMail(uin, param): å¤„ç†å‘é€é‚®ä»¶è¯·æ±‚
â”œâ”€â”€ handleReadMail(uin, param): å¤„ç†è¯»å–é‚®ä»¶è¯·æ±‚
â”œâ”€â”€ handleDeleteMail(uin, param): å¤„ç†åˆ é™¤é‚®ä»¶è¯·æ±‚
â”œâ”€â”€ handleReceiveAttachment(uin, param): å¤„ç†é¢†å–é™„ä»¶è¯·æ±‚
â”œâ”€â”€ LoadPlayerMailFromCloud(player): ä»äº‘ç«¯åŠ è½½é‚®ä»¶æ•°æ®
â”œâ”€â”€ SavePlayerMailToCloud(player): ä¿å­˜é‚®ä»¶æ•°æ®åˆ°äº‘ç«¯
â””â”€â”€ syncMailToClient(uin): åŒæ­¥é‚®ä»¶æ•°æ®åˆ°å®¢æˆ·ç«¯

å®šæ—¶åŒæ­¥æœºåˆ¶ï¼š
â”œâ”€â”€ åˆ›å»ºTimerå®šæ—¶å™¨ (å‚ç…§BagMgr)
â”œâ”€â”€ SyncAllMails(): æ‰¹é‡åŒæ­¥æ‰€æœ‰è„æ•°æ®
â”œâ”€â”€ 2ç§’é—´éš”è‡ªåŠ¨åŒæ­¥
â””â”€â”€ ç³»ç»Ÿé‚®ä»¶å®šæ—¶æ£€æŸ¥

é‚®ä»¶å‘é€ï¼š
â”œâ”€â”€ ç³»ç»Ÿé‚®ä»¶å‘é€æ¥å£
â”œâ”€â”€ ç©å®¶é—´é‚®ä»¶å‘é€
â”œâ”€â”€ æ‰¹é‡é‚®ä»¶å‘é€
â””â”€â”€ é‚®ä»¶æ¨¡æ¿ç³»ç»Ÿ
```

### 4.2 ğŸ”§ [ç®¡ç†å™¨] ä»»åŠ¡ç®¡ç†å™¨å®ç°

#### TaskMgr (ä»»åŠ¡ç®¡ç†å™¨)

```
å‚ç…§ï¼šBagMgrçš„å®ç°æ¨¡å¼
èŒè´£ï¼šç‹¬ç«‹å¤„ç†ä»»åŠ¡ç›¸å…³çš„æ‰€æœ‰åŠŸèƒ½

æ•°æ®å­˜å‚¨ï¼š
server_player_task_data = {}  -- ç©å®¶ä»»åŠ¡æ•°æ®
need_sync_task = {}          -- éœ€è¦åŒæ­¥çš„ä»»åŠ¡

æ ¸å¿ƒæ–¹æ³•ï¼š
â”œâ”€â”€ GetPlayerTask(uin): è·å–ç©å®¶ä»»åŠ¡æ•°æ®
â”œâ”€â”€ setPlayerTaskData(uin, data): è®¾ç½®ä»»åŠ¡æ•°æ®
â”œâ”€â”€ handleAcceptTask(uin, param): å¤„ç†æ¥å—ä»»åŠ¡è¯·æ±‚
â”œâ”€â”€ handleCompleteTask(uin, param): å¤„ç†å®Œæˆä»»åŠ¡è¯·æ±‚
â”œâ”€â”€ handleAbandonTask(uin, param): å¤„ç†æ”¾å¼ƒä»»åŠ¡è¯·æ±‚
â”œâ”€â”€ updateTaskProgress(uin, taskId, progress): æ›´æ–°ä»»åŠ¡è¿›åº¦
â”œâ”€â”€ LoadPlayerTaskFromCloud(player): ä»äº‘ç«¯åŠ è½½ä»»åŠ¡æ•°æ®
â”œâ”€â”€ SavePlayerTaskToCloud(player): ä¿å­˜ä»»åŠ¡æ•°æ®åˆ°äº‘ç«¯
â””â”€â”€ syncTaskToClient(uin): åŒæ­¥ä»»åŠ¡æ•°æ®åˆ°å®¢æˆ·ç«¯

ä»»åŠ¡è¿›åº¦è·Ÿè¸ªï¼š
â”œâ”€â”€ ç›‘å¬æ¸¸æˆäº‹ä»¶è‡ªåŠ¨æ›´æ–°è¿›åº¦
â”œâ”€â”€ å‡»æ€æ€ªç‰©äº‹ä»¶ â†’ æ›´æ–°å‡»æ€ä»»åŠ¡
â”œâ”€â”€ æ”¶é›†ç‰©å“äº‹ä»¶ â†’ æ›´æ–°æ”¶é›†ä»»åŠ¡
â”œâ”€â”€ å¯¹è¯äº‹ä»¶ â†’ æ›´æ–°å¯¹è¯ä»»åŠ¡
â””â”€â”€ å®šæ—¶æ£€æŸ¥ä»»åŠ¡å®Œæˆæ¡ä»¶

ä»»åŠ¡å¥–åŠ±å‘æ”¾ï¼š
â”œâ”€â”€ éªŒè¯ä»»åŠ¡å®Œæˆæ¡ä»¶
â”œâ”€â”€ å‘æ”¾ç»éªŒã€é‡‘å¸å¥–åŠ±
â”œâ”€â”€ å‘æ”¾ç‰©å“å¥–åŠ±åˆ°èƒŒåŒ…
â””â”€â”€ è®°å½•ä»»åŠ¡å®Œæˆå†å²
```

#### FriendMgr (å¥½å‹ç®¡ç†å™¨)

```
å‚ç…§ï¼šBagMgrçš„å®ç°æ¨¡å¼
èŒè´£ï¼šç‹¬ç«‹å¤„ç†å¥½å‹ç›¸å…³çš„æ‰€æœ‰åŠŸèƒ½

æ•°æ®å­˜å‚¨ï¼š
server_player_friend_data = {}  -- ç©å®¶å¥½å‹æ•°æ®
need_sync_friend = {}          -- éœ€è¦åŒæ­¥çš„å¥½å‹

æ ¸å¿ƒæ–¹æ³•ï¼š
â”œâ”€â”€ GetPlayerFriend(uin): è·å–ç©å®¶å¥½å‹æ•°æ®
â”œâ”€â”€ setPlayerFriendData(uin, data): è®¾ç½®å¥½å‹æ•°æ®
â”œâ”€â”€ handleAddFriend(uin, param): å¤„ç†æ·»åŠ å¥½å‹è¯·æ±‚
â”œâ”€â”€ handleRemoveFriend(uin, param): å¤„ç†åˆ é™¤å¥½å‹è¯·æ±‚
â”œâ”€â”€ handleAcceptFriendRequest(uin, param): å¤„ç†æ¥å—å¥½å‹è¯·æ±‚
â”œâ”€â”€ handleRejectFriendRequest(uin, param): å¤„ç†æ‹’ç»å¥½å‹è¯·æ±‚
â”œâ”€â”€ LoadPlayerFriendFromCloud(player): ä»äº‘ç«¯åŠ è½½å¥½å‹æ•°æ®
â”œâ”€â”€ SavePlayerFriendToCloud(player): ä¿å­˜å¥½å‹æ•°æ®åˆ°äº‘ç«¯
â””â”€â”€ syncFriendToClient(uin): åŒæ­¥å¥½å‹æ•°æ®åˆ°å®¢æˆ·ç«¯

å¥½å‹åŠŸèƒ½ï¼š
â”œâ”€â”€ å¥½å‹åœ¨çº¿çŠ¶æ€æ£€æµ‹
â”œâ”€â”€ å¥½å‹äº²å¯†åº¦ç³»ç»Ÿ
â”œâ”€â”€ å¥½å‹èŠå¤©åŠŸèƒ½
â”œâ”€â”€ å¥½å‹ç¤¼ç‰©èµ é€
â””â”€â”€ å¥½å‹æ¨èç³»ç»Ÿ
```

### 4.3 ğŸ”§ [ç®¡ç†å™¨] ç°æœ‰ç³»ç»Ÿé€‚é…

#### ç°æœ‰BagMgr (èƒŒåŒ…ç®¡ç†å™¨) - ä¿æŒä¸å˜

```
ç°çŠ¶ï¼šå·²ç»æ˜¯ç†æƒ³çš„ç®¡ç†å™¨æ¨¡å¼
ä¼˜åŠ¿ï¼š
â”œâ”€â”€ ç‹¬ç«‹çš„æ•°æ®å­˜å‚¨ï¼šserver_player_bag_data
â”œâ”€â”€ å®Œæ•´çš„åŒæ­¥æœºåˆ¶ï¼šneed_sync_bag + Timer
â”œâ”€â”€ äº‘å­˜å‚¨é›†æˆï¼šLoadPlayerBagFromCloud/SavePlayerBagToCloud
â”œâ”€â”€ äº‹ä»¶å¤„ç†ï¼šhandleBtnUseItemç­‰æ–¹æ³•
â””â”€â”€ å®¢æˆ·ç«¯åŒæ­¥ï¼šå®šæ—¶åŒæ­¥è„æ•°æ®

ä»…éœ€å°è°ƒæ•´ï¼š
â”œâ”€â”€ æ•°æ®ç»“æ„ç¨å¾®ç»„ä»¶åŒ–
â”œâ”€â”€ æ·»åŠ ä¸€äº›ä¾¿æ°‘æ–¹æ³•
â””â”€â”€ ä¼˜åŒ–åŒæ­¥æœºåˆ¶
```

#### ç°æœ‰Entityç³»ç»Ÿ - ç®€åŒ–æ”¹é€ 

```
EntityåŸºç±»ï¼š
â”œâ”€â”€ ç§»é™¤å…·ä½“ä¸šåŠ¡å±æ€§ (health, manaç­‰)
â”œâ”€â”€ ä¿ç•™åŸºæœ¬æ ‡è¯† (uin, name, isPlayer)
â”œâ”€â”€ æ·»åŠ ä¾¿æ°‘æ–¹æ³•é‡å®šå‘åˆ°å„ç®¡ç†å™¨
â””â”€â”€ ä¿æŒç°æœ‰çš„Actorå’ŒåŠ¨ç”»ç³»ç»Ÿ

MPlayerç±»ï¼š
â”œâ”€â”€ ç§»é™¤ self.bag å±æ€§
â”œâ”€â”€ ç§»é™¤ self.dict_btn_skill å±æ€§
â”œâ”€â”€ æ·»åŠ  GetBag() â†’ BagMgr.GetPlayerBag(uin)
â”œâ”€â”€ æ·»åŠ  GetSkillData() â†’ SkillMgr.GetPlayerSkill(uin)
â””â”€â”€ ä¿æŒå…¶ä»–ç°æœ‰åŠŸèƒ½ä¸å˜
```

### 4.4 ğŸ”§ [é›†æˆ] æœåŠ¡å™¨å¯åŠ¨åˆå§‹åŒ–

#### MServerMain.luaé›†æˆ

```
initModule()æ–¹æ³•ä¿®æ”¹ï¼š
â”œâ”€â”€ ä¿æŒç°æœ‰çš„BagEventManageråˆå§‹åŒ–
â”œâ”€â”€ æ–°å¢SkillMgrã€MailMgrã€TaskMgrç­‰require
â”œâ”€â”€ å„ç®¡ç†å™¨åœ¨requireæ—¶è‡ªåŠ¨å¯åŠ¨Timer
â”œâ”€â”€ æ³¨å†Œå¯¹åº”çš„ç½‘ç»œäº‹ä»¶å¤„ç†
â””â”€â”€ ä¸éœ€è¦å¤æ‚çš„SystemManager

ç½‘ç»œäº‹ä»¶æ³¨å†Œï¼š
â”œâ”€â”€ ServerEventManager.Subscribe("cmd_learn_skill", SkillMgr.handleLearnSkill)
â”œâ”€â”€ ServerEventManager.Subscribe("cmd_equip_skill", SkillMgr.handleEquipSkill)
â”œâ”€â”€ ServerEventManager.Subscribe("cmd_send_mail", MailMgr.handleSendMail)
â”œâ”€â”€ ServerEventManager.Subscribe("cmd_read_mail", MailMgr.handleReadMail)
â””â”€â”€ ä¿æŒç°æœ‰çš„èƒŒåŒ…äº‹ä»¶æ³¨å†Œ

ç©å®¶æ•°æ®åŠ è½½ï¼š
â”œâ”€â”€ MPlayeråˆå§‹åŒ–æ—¶è°ƒç”¨å„ç®¡ç†å™¨çš„Loadæ–¹æ³•
â”œâ”€â”€ BagMgr.LoadPlayerBagFromCloud(player)
â”œâ”€â”€ SkillMgr.LoadPlayerSkillFromCloud(player)
â”œâ”€â”€ MailMgr.LoadPlayerMailFromCloud(player)
â””â”€â”€ å¼‚æ­¥åŠ è½½ï¼Œé¿å…é˜»å¡
```

## äº”ã€ä¾¿æ°‘æ¥å£å’Œå…¼å®¹æ€§è®¾è®¡

### 5.1 ğŸ­ [ä¾¿æ°‘æ¥å£] ç»Ÿä¸€è®¿é—®æ¥å£

#### GameDataMgr (æ¸¸æˆæ•°æ®ä¾¿æ°‘æ¥å£)

```
èŒè´£ï¼šæä¾›ç»Ÿä¸€çš„æ•°æ®è®¿é—®å…¥å£ï¼Œé¿å…ç›´æ¥è°ƒç”¨å„ç®¡ç†å™¨

ä¾¿æ°‘æ–¹æ³•ï¼š
â”œâ”€â”€ GetPlayerBag(uin): è·å–ç©å®¶èƒŒåŒ… â†’ BagMgr.GetPlayerBag(uin)
â”œâ”€â”€ GetPlayerSkill(uin): è·å–ç©å®¶æŠ€èƒ½ â†’ SkillMgr.GetPlayerSkill(uin)
â”œâ”€â”€ GetPlayerMail(uin): è·å–ç©å®¶é‚®ä»¶ â†’ MailMgr.GetPlayerMail(uin)
â”œâ”€â”€ GetPlayerTask(uin): è·å–ç©å®¶ä»»åŠ¡ â†’ TaskMgr.GetPlayerTask(uin)
â””â”€â”€ GetPlayerFriend(uin): è·å–ç©å®¶å¥½å‹ â†’ FriendMgr.GetPlayerFriend(uin)

æ‰¹é‡æ“ä½œï¼š
â”œâ”€â”€ GetPlayerAllData(uin): è·å–ç©å®¶æ‰€æœ‰æ•°æ®
â”œâ”€â”€ SavePlayerAllData(uin): ä¿å­˜ç©å®¶æ‰€æœ‰æ•°æ®
â”œâ”€â”€ LoadPlayerAllData(player): åŠ è½½ç©å®¶æ‰€æœ‰æ•°æ®
â””â”€â”€ SyncPlayerAllData(uin): åŒæ­¥ç©å®¶æ‰€æœ‰æ•°æ®

ä½¿ç”¨ç¤ºä¾‹ï¼š
-- ç®€åŒ–è°ƒç”¨
local skillData = GameDataMgr.GetPlayerSkill(uin)
-- è€Œä¸æ˜¯
local skillData = SkillMgr.GetPlayerSkill(uin)
```

#### PlayerDataHelper (ç©å®¶æ•°æ®è¾…åŠ©å·¥å…·)

```
èŒè´£ï¼šæä¾›è·¨æ¨¡å—çš„æ•°æ®æ“ä½œä¾¿æ°‘æ–¹æ³•

è·¨æ¨¡å—æ“ä½œï¼š
â”œâ”€â”€ AddItemToPlayer(uin, itemName, amount): æ·»åŠ ç‰©å“åˆ°èƒŒåŒ…
â”œâ”€â”€ ConsumePlayerItem(uin, itemName, amount): æ¶ˆè€—ç©å®¶ç‰©å“
â”œâ”€â”€ SendSystemMail(uin, title, content, attachments): å‘é€ç³»ç»Ÿé‚®ä»¶
â”œâ”€â”€ GiveSkillToPlayer(uin, skillId): ç»™ç©å®¶æŠ€èƒ½
â””â”€â”€ CompleteTaskForPlayer(uin, taskId): å®Œæˆç©å®¶ä»»åŠ¡

æ•°æ®éªŒè¯ï¼š
â”œâ”€â”€ ValidatePlayerData(uin): éªŒè¯ç©å®¶æ•°æ®å®Œæ•´æ€§
â”œâ”€â”€ CheckPlayerResource(uin, resourceType, amount): æ£€æŸ¥ç©å®¶èµ„æº
â”œâ”€â”€ GetPlayerStatus(uin): è·å–ç©å®¶çŠ¶æ€æ‘˜è¦
â””â”€â”€ FixPlayerData(uin): ä¿®å¤ç©å®¶æ•°æ®å¼‚å¸¸

å¸¸ç”¨ç»„åˆæ“ä½œï¼š
â”œâ”€â”€ RewardPlayer(uin, rewards): å¥–åŠ±ç©å®¶(ç‰©å“+é‚®ä»¶+æŠ€èƒ½)
â”œâ”€â”€ PunishPlayer(uin, punishment): æƒ©ç½šç©å®¶
â””â”€â”€ ResetPlayerData(uin, dataType): é‡ç½®ç©å®¶æŒ‡å®šæ•°æ®
```

### 5.2 ğŸ­ [å…¼å®¹é€‚é…] ç°æœ‰æ¥å£ä¿æŒ

#### MPlayerç±»æ–¹æ³•é€‚é…

```
èŒè´£ï¼šä¿æŒMPlayerç°æœ‰æ¥å£ä¸å˜ï¼Œå†…éƒ¨é‡å®šå‘åˆ°å„ç®¡ç†å™¨

ç°æœ‰æ–¹æ³•ä¿æŒï¼š
â”œâ”€â”€ MPlayer:GetBag() â†’ BagMgr.GetPlayerBag(self.uin)
â”œâ”€â”€ MPlayer:syncSkillData() â†’ SkillMgr.syncSkillToClient(self.uin)
â”œâ”€â”€ MPlayer:leaveGame() â†’ è°ƒç”¨æ‰€æœ‰ç®¡ç†å™¨çš„Saveæ–¹æ³•
â””â”€â”€ å…¶ä»–ç°æœ‰æ–¹æ³•ä¿æŒä¸å˜

æ–°å¢ä¾¿æ°‘æ–¹æ³•ï¼š
â”œâ”€â”€ MPlayer:GetSkillData() â†’ SkillMgr.GetPlayerSkill(self.uin)
â”œâ”€â”€ MPlayer:GetMailData() â†’ MailMgr.GetPlayerMail(self.uin)
â”œâ”€â”€ MPlayer:GetTaskData() â†’ TaskMgr.GetPlayerTask(self.uin)
â””â”€â”€ MPlayer:GetFriendData() â†’ FriendMgr.GetPlayerFriend(self.uin)

ä¿æŒåŸæœ‰è°ƒç”¨æ–¹å¼ï¼š
-- ç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹
local bag = player:GetBag()
player:syncSkillData()
player:leaveGame()
```

#### ç½‘ç»œäº‹ä»¶å…¼å®¹

```
èŒè´£ï¼šä¿æŒç°æœ‰ç½‘ç»œäº‹ä»¶å¤„ç†æ–¹å¼ä¸å˜

ç°æœ‰äº‹ä»¶ä¿æŒï¼š
â”œâ”€â”€ cmd_use_item â†’ BagMgr.handleBtnUseItem (å·²æœ‰)
â”œâ”€â”€ cmd_decompose â†’ BagMgr.handleBtnDecompose (å·²æœ‰)
â”œâ”€â”€ cmd_swap_items â†’ BagMgr.handlePlayerItemsChange (å·²æœ‰)
â””â”€â”€ å…¶ä»–èƒŒåŒ…äº‹ä»¶ä¿æŒä¸å˜

æ–°å¢äº‹ä»¶å¤„ç†ï¼š
â”œâ”€â”€ cmd_learn_skill â†’ SkillMgr.handleLearnSkill
â”œâ”€â”€ cmd_equip_skill â†’ SkillMgr.handleEquipSkill
â”œâ”€â”€ cmd_send_mail â†’ MailMgr.handleSendMail
â”œâ”€â”€ cmd_read_mail â†’ MailMgr.handleReadMail
â”œâ”€â”€ cmd_accept_task â†’ TaskMgr.handleAcceptTask
â””â”€â”€ cmd_add_friend â†’ FriendMgr.handleAddFriend

äº‹ä»¶æ³¨å†Œæ–¹å¼ï¼š
-- åœ¨MServerMain.luaçš„initModule()ä¸­
ServerEventManager.Subscribe("cmd_learn_skill", SkillMgr.handleLearnSkill)
ServerEventManager.Subscribe("cmd_equip_skill", SkillMgr.handleEquipSkill)
-- ä¿æŒç°æœ‰çš„æ³¨å†Œæ–¹å¼ä¸å˜
```

### 5.3 ğŸ­ [æ•°æ®è¿ç§»] å…¼å®¹æ€§è¿ç§»

#### æ•°æ®ç»“æ„å…¼å®¹

```
èŒè´£ï¼šç¡®ä¿ç°æœ‰å­˜æ¡£æ•°æ®èƒ½æ­£å¸¸è¿ç§»åˆ°æ–°ç»“æ„

èƒŒåŒ…æ•°æ®å…¼å®¹ï¼š
â”œâ”€â”€ ç°æœ‰Bag.luaæ•°æ®ç»“æ„åŸºæœ¬ä¿æŒä¸å˜
â”œâ”€â”€ åªéœ€è¦ç¨å¾®è°ƒæ•´æ•°æ®ç»„ç»‡æ–¹å¼
â”œâ”€â”€ Loadå’ŒSaveæ–¹æ³•ä¿æŒå…¼å®¹
â””â”€â”€ å®¢æˆ·ç«¯åŒæ­¥æ ¼å¼ä¸å˜

æŠ€èƒ½æ•°æ®è¿ç§»ï¼š
â”œâ”€â”€ ä»MPlayerçš„dict_btn_skillè¿ç§»åˆ°SkillMgr
â”œâ”€â”€ æä¾›æ•°æ®è¿ç§»è„šæœ¬
â”œâ”€â”€ ä¿æŒå®¢æˆ·ç«¯æŠ€èƒ½åŒæ­¥åè®®ä¸å˜
â””â”€â”€ é€æ­¥è¿ç§»ï¼Œæ–°è€å¹¶å­˜

äº‘å­˜å‚¨å…¼å®¹ï¼š
â”œâ”€â”€ ä¿æŒç°æœ‰çš„äº‘å­˜å‚¨keyæ ¼å¼
â”œâ”€â”€ 'inv' + uin â†’ èƒŒåŒ…æ•°æ® (ä¸å˜)
â”œâ”€â”€ 'skill' + uin â†’ æŠ€èƒ½æ•°æ® (æ–°å¢)
â”œâ”€â”€ 'mail' + uin â†’ é‚®ä»¶æ•°æ® (æ–°å¢)
â””â”€â”€ æ¸è¿›å¼è¿ç§»äº‘å­˜å‚¨æ•°æ®
```

## å…­ã€äº‹ä»¶æµç¨‹å’Œåä½œè®¾è®¡

### 6.1 ç°æœ‰äº‹ä»¶ç³»ç»Ÿåˆ©ç”¨

```
äº‹ä»¶æ€»çº¿è®¾è®¡ï¼š
EventBus = {
    subscribers = {},
    
    Subscribe(eventType, callback): è®¢é˜…äº‹ä»¶
    Publish(eventType, eventData): å‘å¸ƒäº‹ä»¶
    Unsubscribe(eventType, callback): å–æ¶ˆè®¢é˜…
}

æ ¸å¿ƒäº‹ä»¶ç±»å‹ï¼š
â”œâ”€â”€ cmd_learn_skill: å­¦ä¹ æŠ€èƒ½è¯·æ±‚
â”œâ”€â”€ cmd_equip_skill: è£…å¤‡æŠ€èƒ½è¯·æ±‚  
â”œâ”€â”€ cmd_send_mail: å‘é€é‚®ä»¶è¯·æ±‚
â”œâ”€â”€ cmd_read_mail: è¯»å–é‚®ä»¶è¯·æ±‚
â”œâ”€â”€ cmd_use_item: ä½¿ç”¨ç‰©å“è¯·æ±‚
â””â”€â”€ cmd_accept_task: æ¥å—ä»»åŠ¡è¯·æ±‚
```

### ç®¡ç†å™¨é—´åä½œæµç¨‹

```
æŠ€èƒ½å­¦ä¹ å®Œæ•´æµç¨‹ï¼š
1. ğŸ“± å®¢æˆ·ç«¯å‘é€ cmd_learn_skill äº‹ä»¶
2. ğŸŒ ServerEventManager è·¯ç”±åˆ° SkillMgr.handleLearnSkill
3. ğŸ­ SkillMgr éªŒè¯æŠ€èƒ½å­¦ä¹ æ¡ä»¶
4. ğŸ­ SkillMgr æ‰£é™¤æŠ€èƒ½ç‚¹ï¼Œæ›´æ–°æŠ€èƒ½æ•°æ®
5. ğŸ­ SkillMgr æ ‡è®°need_sync_skillï¼Œå‡†å¤‡åŒæ­¥
6. â° å®šæ—¶å™¨è§¦å‘ SyncAllSkills()
7. ğŸ“¤ SkillMgr.syncSkillToClient() åŒæ­¥åˆ°å®¢æˆ·ç«¯
8. ğŸ’¾ å®šæœŸè°ƒç”¨ SavePlayerSkillToCloud() ä¿å­˜äº‘ç«¯

è·¨æ¨¡å—åä½œç¤ºä¾‹(ä»»åŠ¡å¥–åŠ±)ï¼š
1. ğŸ¯ TaskMgr æ£€æµ‹ä»»åŠ¡å®Œæˆ
2. ğŸ è°ƒç”¨ PlayerDataHelper.RewardPlayer()
3. ğŸ“¦ BagMgr.AddItemToPlayer() æ·»åŠ ç‰©å“å¥–åŠ±
4. ğŸ­ SkillMgr.GiveSkillToPlayer() ç»™äºˆæŠ€èƒ½å¥–åŠ±  
5. ğŸ“§ MailMgr.SendSystemMail() å‘é€å¥–åŠ±é‚®ä»¶
6. ğŸ”„ å„ç®¡ç†å™¨åˆ†åˆ«åŒæ­¥æ•°æ®åˆ°å®¢æˆ·ç«¯
```

## ä¸ƒã€å®æ–½è®¡åˆ’

### 7.1 å¼€å‘é˜¶æ®µ (æ€»è®¡6å‘¨)

#### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ¡†æ¶ (1å‘¨)

```
ä¼˜å…ˆçº§1ï¼šEntityç®€åŒ–
â”œâ”€â”€ ç®€åŒ–EntityåŸºç±»ï¼Œç§»é™¤ä¸šåŠ¡å±æ€§
â”œâ”€â”€ ä¿®æ”¹MPlayerï¼Œç§»é™¤bagå’Œdict_btn_skill
â”œâ”€â”€ æ·»åŠ é‡å®šå‘æ–¹æ³•åˆ°å„ç®¡ç†å™¨
â””â”€â”€ ä¿æŒç°æœ‰Actorå’ŒåŠ¨ç”»ç³»ç»Ÿ

ä¼˜å…ˆçº§2ï¼šåŸºç¡€å·¥å…·
â”œâ”€â”€ GameDataMgrä¾¿æ°‘æ¥å£
â”œâ”€â”€ PlayerDataHelperè¾…åŠ©å·¥å…·
â””â”€â”€ åŸºç¡€æµ‹è¯•å’ŒéªŒè¯
```

#### ç¬¬äºŒé˜¶æ®µï¼šæŠ€èƒ½ç®¡ç†å™¨ (2å‘¨)

```
ä¼˜å…ˆçº§3ï¼šSkillMgrå¼€å‘
â”œâ”€â”€ å‚ç…§BagMgråˆ›å»ºSkillMgr
â”œâ”€â”€ å®ç°æŠ€èƒ½æ•°æ®ç»“æ„å®šä¹‰
â”œâ”€â”€ å®ç°å­¦ä¹ ã€è£…å¤‡ã€å‡çº§åŠŸèƒ½
â”œâ”€â”€ æ·»åŠ å®šæ—¶åŒæ­¥æœºåˆ¶
â”œâ”€â”€ å®ç°äº‘å­˜å‚¨åŠ è½½/ä¿å­˜
â””â”€â”€ æ·»åŠ ç½‘ç»œäº‹ä»¶å¤„ç†

ä¼˜å…ˆçº§4ï¼šæŠ€èƒ½ç³»ç»Ÿé›†æˆ
â”œâ”€â”€ åœ¨MServerMainä¸­é›†æˆSkillMgr
â”œâ”€â”€ æ³¨å†ŒæŠ€èƒ½ç›¸å…³ç½‘ç»œäº‹ä»¶
â”œâ”€â”€ æµ‹è¯•æŠ€èƒ½åŠŸèƒ½å®Œæ•´æ€§
â””â”€â”€ æ•°æ®è¿ç§»è„šæœ¬å¼€å‘
```

#### ç¬¬ä¸‰é˜¶æ®µï¼šé‚®ä»¶å’Œä»»åŠ¡ç³»ç»Ÿ (2å‘¨)

```
ä¼˜å…ˆçº§5ï¼šMailMgrå’ŒTaskMgrå¼€å‘
â”œâ”€â”€ åˆ›å»ºMailMgr (å‚ç…§BagMgr)
â”œâ”€â”€ åˆ›å»ºTaskMgr (å‚ç…§BagMgr)
â”œâ”€â”€ å®ç°å¯¹åº”çš„æ•°æ®ç»“æ„
â”œâ”€â”€ å®ç°æ ¸å¿ƒåŠŸèƒ½æ–¹æ³•
â”œâ”€â”€ æ·»åŠ å®šæ—¶åŒæ­¥æœºåˆ¶
â”œâ”€â”€ å®ç°äº‘å­˜å‚¨é›†æˆ
â””â”€â”€ æ·»åŠ ç½‘ç»œäº‹ä»¶å¤„ç†

ä¼˜å…ˆçº§6ï¼šç³»ç»Ÿé›†æˆæµ‹è¯•
â”œâ”€â”€ é›†æˆæ‰€æœ‰æ–°ç®¡ç†å™¨
â”œâ”€â”€ æµ‹è¯•è·¨æ¨¡å—åŠŸèƒ½
â”œâ”€â”€ éªŒè¯æ•°æ®ä¸€è‡´æ€§
â””â”€â”€ æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–
```

#### ç¬¬å››é˜¶æ®µï¼šå…¼å®¹æ€§å’Œä¼˜åŒ– (1å‘¨)

```
ä¼˜å…ˆçº§7ï¼šå…¼å®¹æ€§ä¿è¯
â”œâ”€â”€ éªŒè¯ç°æœ‰æ¥å£å…¼å®¹æ€§
â”œâ”€â”€ å®Œå–„æ•°æ®è¿ç§»è„šæœ¬
â”œâ”€â”€ æµ‹è¯•ç°æœ‰åŠŸèƒ½æ— å›å½’
â””â”€â”€ å®¢æˆ·ç«¯åè®®å…¼å®¹æ€§æµ‹è¯•

ä¼˜å…ˆçº§8ï¼šæ–‡æ¡£å’Œæ”¶å°¾
â”œâ”€â”€ æ›´æ–°å¼€å‘æ–‡æ¡£
â”œâ”€â”€ æ€§èƒ½ä¼˜åŒ–
â”œâ”€â”€ é”™è¯¯å¤„ç†å®Œå–„
â””â”€â”€ ä»£ç æ¸…ç†å’Œæ³¨é‡Š
```

### 7.2 è¿ç§»ç­–ç•¥

#### æ¸è¿›å¼è¿ç§»æ–¹æ¡ˆ

```
é˜¶æ®µ1ï¼šæŠ€èƒ½ç³»ç»Ÿå…ˆè¡Œ (ç¬¬2å‘¨)
â”œâ”€â”€ å…ˆè¿ç§»æŠ€èƒ½ç³»ç»Ÿåˆ°SkillMgr
â”œâ”€â”€ ä¿æŒç°æœ‰èƒŒåŒ…ç³»ç»Ÿä¸å˜
â”œâ”€â”€ æµ‹è¯•æŠ€èƒ½åŠŸèƒ½å®Œæ•´æ€§
â””â”€â”€ éªŒè¯æ€§èƒ½å’Œç¨³å®šæ€§

é˜¶æ®µ2ï¼šé‚®ä»¶ä»»åŠ¡è·Ÿè¿› (ç¬¬3-4å‘¨)
â”œâ”€â”€ é€æ­¥æ·»åŠ MailMgrå’ŒTaskMgr
â”œâ”€â”€ ä¿æŒç°æœ‰ç³»ç»Ÿå¹¶è¡Œè¿è¡Œ
â”œâ”€â”€ å°èŒƒå›´æµ‹è¯•æ–°åŠŸèƒ½
â””â”€â”€ æ”¶é›†ä½¿ç”¨åé¦ˆ

é˜¶æ®µ3ï¼šå…¨é¢åˆ‡æ¢ (ç¬¬5-6å‘¨)
â”œâ”€â”€ å®Œå…¨åˆ‡æ¢åˆ°æ–°æ¶æ„
â”œâ”€â”€ ç§»é™¤å†—ä½™ä»£ç 
â”œâ”€â”€ æ€§èƒ½ä¼˜åŒ–
â””â”€â”€ ç¨³å®šæ€§éªŒè¯

æ•°æ®è¿ç§»å®‰å…¨ç­–ç•¥ï¼š
â”œâ”€â”€ ä¿ç•™åŸæœ‰æ•°æ®æ ¼å¼å…¼å®¹
â”œâ”€â”€ æ–°è€æ•°æ®å¹¶å­˜ä¸€æ®µæ—¶é—´
â”œâ”€â”€ æä¾›å›æ»šæœºåˆ¶
â”œâ”€â”€ åˆ†æ‰¹æ¬¡è¿ç§»ç”¨æˆ·æ•°æ®
â””â”€â”€ ç›‘æ§è¿ç§»è¿‡ç¨‹å¼‚å¸¸
```

## å…«ã€è´¨é‡ä¿è¯

### 8.1 æµ‹è¯•ç­–ç•¥

```
å•å…ƒæµ‹è¯•ï¼š
â”œâ”€â”€ å„ç®¡ç†å™¨åŠŸèƒ½æ­£ç¡®æ€§æµ‹è¯•
â”œâ”€â”€ æ•°æ®ç»“æ„å®Œæ•´æ€§æµ‹è¯•
â”œâ”€â”€ äº‘å­˜å‚¨åŠ è½½/ä¿å­˜æµ‹è¯•
â””â”€â”€ è¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸æµ‹è¯•

é›†æˆæµ‹è¯•ï¼š
â”œâ”€â”€ ç®¡ç†å™¨é—´åä½œæµ‹è¯•
â”œâ”€â”€ ç½‘ç»œäº‹ä»¶å¤„ç†æµ‹è¯•
â”œâ”€â”€ æ•°æ®ä¸€è‡´æ€§æµ‹è¯•
â””â”€â”€ æ€§èƒ½åŸºå‡†æµ‹è¯•

å…¼å®¹æ€§æµ‹è¯•ï¼š
â”œâ”€â”€ ç°æœ‰åŠŸèƒ½å›å½’æµ‹è¯•
â”œâ”€â”€ æ•°æ®è¿ç§»æµ‹è¯•
â”œâ”€â”€ MPlayeræ¥å£å…¼å®¹æµ‹è¯•
â””â”€â”€ å®¢æˆ·ç«¯åè®®å…¼å®¹æµ‹è¯•

å‹åŠ›æµ‹è¯•ï¼š
â”œâ”€â”€ å¤§é‡ç©å®¶æ•°æ®å¹¶å‘è®¿é—®
â”œâ”€â”€ å®šæ—¶åŒæ­¥æ€§èƒ½æµ‹è¯•
â”œâ”€â”€ äº‘å­˜å‚¨è¯»å†™å‹åŠ›æµ‹è¯•
â””â”€â”€ å†…å­˜ä½¿ç”¨ç›‘æ§æµ‹è¯•
```

### 8.2 æ€§èƒ½ç›‘æ§

```
å…³é”®æŒ‡æ ‡ç›‘æ§ï¼š
â”œâ”€â”€ å„ç®¡ç†å™¨æ•°æ®æŸ¥è¯¢æ€§èƒ½
â”œâ”€â”€ å®šæ—¶åŒæ­¥æ‰§è¡Œæ—¶é—´
â”œâ”€â”€ å†…å­˜ä½¿ç”¨æƒ…å†µ
â”œâ”€â”€ äº‘å­˜å‚¨è®¿é—®å»¶è¿Ÿ
â””â”€â”€ ç½‘ç»œåŒæ­¥æ•ˆç‡

ä¼˜åŒ–ç­–ç•¥ï¼š
â”œâ”€â”€ ç¼“å­˜é¢‘ç¹è®¿é—®çš„ç©å®¶æ•°æ®
â”œâ”€â”€ ä¼˜åŒ–å®šæ—¶åŒæ­¥æ‰¹é‡å¤„ç†
â”œâ”€â”€ æ•°æ®ç»“æ„è®¿é—®å±€éƒ¨æ€§ä¼˜åŒ–
â”œâ”€â”€ äº‘å­˜å‚¨è®¿é—®é¢‘ç‡æ§åˆ¶
â””â”€â”€ å†…å­˜ä½¿ç”¨ä¼˜åŒ–å’Œæ¸…ç†

ç›‘æ§å·¥å…·ï¼š
â”œâ”€â”€ æ€§èƒ½è®¡æ—¶å™¨åŸ‹ç‚¹
â”œâ”€â”€ å†…å­˜ä½¿ç”¨ç»Ÿè®¡
â”œâ”€â”€ é”™è¯¯æ—¥å¿—è®°å½•
â”œâ”€â”€ æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
â””â”€â”€ ç©å®¶æ“ä½œæˆåŠŸç‡ç»Ÿè®¡
```

## ä¹ã€æ€»ç»“

### 9.1 è®¾è®¡ä¼˜åŠ¿

```
âœ… æ¶æ„ç®€æ´ï¼šæ— éœ€å¤æ‚çš„ECSæ¡†æ¶ï¼Œå‚ç…§ç°æœ‰BagMgræ¨¡å¼
âœ… å­¦ä¹ æˆæœ¬ä½ï¼šå¼€å‘è€…å®¹æ˜“ç†è§£ï¼Œç¬¦åˆç°æœ‰ä»£ç é£æ ¼
âœ… å¯æ‰©å±•ï¼šæ–°å¢åŠŸèƒ½åªéœ€åˆ›å»ºæ–°çš„XXXMgr
âœ… æ˜“æµ‹è¯•ï¼šæ¯ä¸ªç®¡ç†å™¨ç‹¬ç«‹ï¼Œä¾¿äºå•å…ƒæµ‹è¯•
âœ… å…¼å®¹æ€§å¼ºï¼šæœ€å¤§ç¨‹åº¦ä¿æŒç°æœ‰æ¥å£å’Œæ•°æ®æ ¼å¼
```

### 9.2 æ ¸å¿ƒä»·å€¼

```
1. æ¨¡å—åŒ–ç®¡ç†ï¼šæ¯ä¸ªåŠŸèƒ½ç‹¬ç«‹ç®¡ç†ï¼ŒèŒè´£æ¸…æ™°
   - BagMgrï¼šç®¡ç†èƒŒåŒ…ç›¸å…³çš„æ‰€æœ‰åŠŸèƒ½
   - SkillMgrï¼šç®¡ç†æŠ€èƒ½ç›¸å…³çš„æ‰€æœ‰åŠŸèƒ½
   - MailMgrï¼šç®¡ç†é‚®ä»¶ç›¸å…³çš„æ‰€æœ‰åŠŸèƒ½

2. æ•°æ®ç»„ä»¶åŒ–ï¼šæ•°æ®ç»“æ„ç»„ä»¶åŒ–ï¼Œä½†ä¿æŒç®€å•
   - èƒŒåŒ…æ•°æ®ã€æŠ€èƒ½æ•°æ®ã€é‚®ä»¶æ•°æ®åˆ†åˆ«å­˜å‚¨
   - æ¯ä¸ªç®¡ç†å™¨è´Ÿè´£è‡ªå·±çš„æ•°æ®åŒæ­¥å’Œå­˜å‚¨

3. å…¼å®¹ç°æœ‰ï¼šæœ€å°åŒ–ä¿®æ”¹ç°æœ‰ä»£ç 
   - MPlayeræ¥å£ä¿æŒä¸å˜
   - ç½‘ç»œäº‹ä»¶å¤„ç†æ–¹å¼ä¿æŒä¸å˜
   - äº‘å­˜å‚¨æ ¼å¼åŸºæœ¬å…¼å®¹

4. æ¸è¿›è¿ç§»ï¼šå¯ä»¥åˆ†é˜¶æ®µå®æ–½
   - å…ˆè¿ç§»æŠ€èƒ½ç³»ç»ŸéªŒè¯å¯è¡Œæ€§
   - å†é€æ­¥æ·»åŠ å…¶ä»–åŠŸèƒ½æ¨¡å—
   - ä¿æŒæ–°è€ç³»ç»Ÿå¹¶è¡Œè¿è¡Œ

5. ç»´æŠ¤ç®€å•ï¼šæ¯ä¸ªç®¡ç†å™¨ç‹¬ç«‹ç»´æŠ¤
   - å‚ç…§BagMgrçš„æˆç†Ÿæ¨¡å¼
   - å®šæ—¶åŒæ­¥ã€äº‘å­˜å‚¨ã€äº‹ä»¶å¤„ç†ç»Ÿä¸€é£æ ¼
   - ä¾¿äºåç»­åŠŸèƒ½æ‰©å±•
```

### 9.3 å®æ–½å»ºè®®

```
ç«‹å³è¡ŒåŠ¨é¡¹ï¼š
1. å…ˆå®æ–½SkillMgrï¼ŒéªŒè¯æ¶æ„å¯è¡Œæ€§
2. ä¿æŒBagMgrä¸å˜ï¼Œä½œä¸ºå‚è€ƒæ¨¡æ¿
3. é€æ­¥æ·»åŠ å…¶ä»–ç®¡ç†å™¨

é•¿æœŸè§„åˆ’ï¼š
1. æ‰€æœ‰ç©å®¶æ•°æ®éƒ½é‡‡ç”¨XXXMgræ¨¡å¼ç®¡ç†
2. å»ºç«‹ç»Ÿä¸€çš„æ•°æ®è®¿é—®å±‚(GameDataMgr)
3. å®Œå–„è·¨æ¨¡å—çš„æ•°æ®æ“ä½œå·¥å…·(PlayerDataHelper)
```

è¿™ä¸ª**æ¨¡å—åŒ–ç»„ä»¶ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ**æä¾›äº†ä¸€ä¸ª**ç®€å•å®ç”¨**çš„æ¶æ„å‡çº§è·¯å¾„ï¼Œæ—¢èƒ½è·å¾—**æ•°æ®é€»è¾‘åˆ†ç¦»**çš„ä¼˜åŠ¿ï¼Œåˆ**ä¿æŒäº†ä¸ç°æœ‰ç³»ç»Ÿçš„æœ€å¤§å…¼å®¹æ€§**ï¼Œæ˜¯ä¸€ä¸ª**ä½é£é™©ã€é«˜æ”¶ç›Š**çš„é‡æ„æ–¹æ¡ˆã€‚